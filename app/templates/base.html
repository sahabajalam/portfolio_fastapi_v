<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ app_name }}{% endblock %}</title>

    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Devicon: official technology icons (Airflow, MLflow, etc.) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/devicon.min.css">

    <!-- Premium Font Pairing: Poppins (body) + Outfit (headings) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Custom CSS - Modular Architecture -->
    <link rel="stylesheet" href="/static/css/styles-modular.css?v=16.0">

    <!-- Critical CSS for mobile footer -->
    <style>
        /* Force hide Quick Links on mobile - inline critical CSS */
        @media (max-width: 767px) {
            .footer-quick-links {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                height: 0 !important;
                overflow: hidden !important;
                max-height: 0 !important;
            }
        }

        /* Show on desktop */
        @media (min-width: 768px) {
            .footer-quick-links {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                height: auto !important;
            }
        }
    </style>

    {% block extra_css %}{% endblock %}

    <!-- Favicon -->
    <link rel="icon" href="/assets/code.svg" type="image/svg+xml">
    <link rel="shortcut icon" href="/assets/code.svg">

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Custom CSS variable mappings
                        'bg-primary': '#ffffff',
                        'bg-secondary': '#fafafa',
                        'bg-card': '#f5f5f5',
                        'bg-card-alt': '#f0f0f0',
                        'text-primary': '#000000',
                        'text-secondary': '#333333',
                        'text-tertiary': '#666666',
                        'text-accent': '#1e40af',
                        primary: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            500: '#111827',
                            600: '#111827',
                            700: '#0f172a'
                        },
                        secondary: {
                            500: '#374151',
                            600: '#374151',
                            700: '#1f2937'
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.8s ease-out forwards',
                        'shimmer': 'shimmer 2s infinite',
                        'pulse-slow': 'pulse 3s infinite'
                    }
                }
            }
        }
    </script>

    {% block extra_head %}{% endblock %}
</head>

<body class="bg-gray-50 min-h-screen font-sans antialiased">
    <!-- Navigation -->
    {% include 'components/navigation.html' %}

    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    {% include 'components/footer.html' %}

    <!-- Floating Chat Button -->
    <button id="chatToggleBtn"
        class="fixed bottom-6 right-6 z-50 btn-primary text-white px-4 py-3 md:px-5 md:py-3 rounded-full shadow-xl transition-transform duration-200 flex items-center gap-2"
        type="button" aria-label="Open Chat" aria-expanded="false">
        <i class="fas fa-comment-dots text-xl"></i>
        <span class="font-semibold text-sm hidden md:inline">Ask Alam</span>
    </button>

    <!-- Chat Interface (Hidden by default) -->
    <div id="chatInterface" class="hidden">
        {% include 'components/chat_interface.html' %}
    </div>

    <!-- JavaScript -->
    <script type="module">
        // Import modular components
        import { NavigationManager } from '/static/js/modules/navigation.js';
        import { ChatManager } from '/static/js/modules/chat.js';
        import { AnimationManager } from '/static/js/modules/animations.js';

        // Define toggleChat function early to ensure it's available
        let isChatOpen = false;
        const chatToggleBtn = document.getElementById('chatToggleBtn');
        const chatInterface = document.getElementById('chatInterface');

        window.toggleChat = function () {
            console.log('üñ±Ô∏è toggleChat called! Current state:', isChatOpen);
            isChatOpen = !isChatOpen;

            if (isChatOpen) {
                chatInterface.classList.remove('hidden');
                chatInterface.classList.add('animate-fade-in-up');
                chatToggleBtn.classList.add('hidden');
                chatToggleBtn.setAttribute('aria-expanded', 'true');

                // Lock body scroll on mobile
                if (window.innerWidth <= 640) {
                    document.body.classList.add('chat-open-mobile');
                }

                console.log('‚úÖ Chat opened');
            } else {
                chatInterface.classList.add('hidden');
                chatInterface.classList.remove('animate-fade-in-up');
                chatToggleBtn.classList.remove('hidden');
                chatToggleBtn.innerHTML = '<i class="fas fa-comment-dots text-xl"></i><span class="font-semibold text-sm hidden md:inline">Ask Alam</span>';
                chatToggleBtn.setAttribute('aria-label', 'Open Chat');
                chatToggleBtn.setAttribute('aria-expanded', 'false');

                // Unlock body scroll
                document.body.classList.remove('chat-open-mobile');

                console.log('‚úÖ Chat closed');
            }
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Initializing Modular Portfolio Application...');

            // Initialize all modules
            new NavigationManager();
            window.chatManager = new ChatManager(); // Store globally for compatibility
            new AnimationManager();

            // Chat Toggle Functionality (already defined above)
            if (!chatToggleBtn || !chatInterface) {
                console.error('‚ùå Chat elements not found!', { chatToggleBtn, chatInterface });
                return;
            }

            console.log('‚úÖ Chat elements found successfully');

            chatToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                console.log('üñ±Ô∏è Chat button clicked via event listener!');
                window.toggleChat();
            });

            // Close chat when clicking outside (desktop only) or on backdrop (mobile)
            document.addEventListener('click', (e) => {
                if (isChatOpen) {
                    const isMobile = window.innerWidth <= 640;
                    const clickedOutside = !chatInterface.contains(e.target) && !chatToggleBtn.contains(e.target);

                    // On mobile, only close if clicked on backdrop (outside chat panel)
                    // On desktop, close if clicked anywhere outside
                    if (isMobile) {
                        const chatPanel = chatInterface.querySelector('.chat-panel');
                        if (clickedOutside || (chatPanel && !chatPanel.contains(e.target))) {
                            console.log('üñ±Ô∏è Clicked on backdrop, closing chat');
                            window.toggleChat();
                        }
                    } else if (clickedOutside) {
                        console.log('üñ±Ô∏è Clicked outside, closing chat');
                        window.toggleChat();
                    }
                }
            });

            console.log('‚úÖ Modular Portfolio App initialized successfully');
        });

        // Performance monitoring
        window.addEventListener('load', () => {
            const loadTime = performance.now();
            console.log(`‚ö° Page loaded in ${Math.round(loadTime)}ms`);
        });

        // Error handling
        window.addEventListener('error', (event) => {
            console.error('üí• JavaScript error:', event.error);
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            console.error('üí• Unhandled promise rejection:', event.reason);
            event.preventDefault();
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>